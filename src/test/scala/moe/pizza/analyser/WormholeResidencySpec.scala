package moe.pizza.analyser

import com.fasterxml.jackson.databind.ObjectMapper
import com.fasterxml.jackson.module.scala.DefaultScalaModule
import moe.pizza.analyser.WormholeResidency.ResidencyModifier
import moe.pizza.zkapi.zkillboard.Killmail
import org.joda.time.DateTime
import org.scalatest.{MustMatchers, FlatSpec}

/**
 * Created by Andi on 12/11/2015.
 */
class WormholeResidencySpec extends FlatSpec with MustMatchers {
  "the residency modifier calculator" should "calculate residency on an example pos killmail" in {
    val originalkm ="""{"killID":50129206,"solarSystemID":31001669,"killTime":"KILLTIME","moonID":40437462,"victim":{"shipTypeID":20060,"characterID":0,"characterName":"","corporationID":98142695,"corporationName":"NEMESIS INCORPORATED","allianceID":99004557,"allianceName":"NEMESIS INC UNITED","factionID":0,"factionName":"","damageTaken":13532616},"attackers":[{"characterID":1399881500,"characterName":"Wodo Prophet","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.1,"damageDone":2586683,"finalBlow":0,"weaponTypeID":4306,"shipTypeID":4306},{"characterID":92973922,"characterName":"Kisiar Akriana","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":5,"damageDone":2519495,"finalBlow":0,"weaponTypeID":4302,"shipTypeID":4302},{"characterID":2031871134,"characterName":"Boschala","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":4.6,"damageDone":2195331,"finalBlow":0,"weaponTypeID":28213,"shipTypeID":12005},{"characterID":90515018,"characterName":"Yan Skshetuski","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":2.8,"damageDone":1859096,"finalBlow":1,"weaponTypeID":28211,"shipTypeID":12005},{"characterID":90120220,"characterName":"Bo Rothrock","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.2,"damageDone":1805986,"finalBlow":0,"weaponTypeID":24490,"shipTypeID":12019},{"characterID":92705980,"characterName":"Rioghal Morgan","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":-1.4,"damageDone":935260,"finalBlow":0,"weaponTypeID":28211,"shipTypeID":17843},{"characterID":1522635122,"characterName":"USSDUCK","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.5,"damageDone":548229,"finalBlow":0,"weaponTypeID":27413,"shipTypeID":11995},{"characterID":95851868,"characterName":"Temari Uzumaki","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.7,"damageDone":319799,"finalBlow":0,"weaponTypeID":8105,"shipTypeID":24698},{"characterID":93106560,"characterName":"Keyra D","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":-1,"damageDone":266400,"finalBlow":0,"weaponTypeID":4310,"shipTypeID":4310},{"characterID":1938464267,"characterName":"USSDUCKY","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":0,"damageDone":180602,"finalBlow":0,"weaponTypeID":24700,"shipTypeID":24700},{"characterID":95423733,"characterName":"Ciara Huskarl","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":0,"damageDone":170764,"finalBlow":0,"weaponTypeID":12013,"shipTypeID":12013},{"characterID":94047230,"characterName":"BaldlyGoForth","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":4.3,"damageDone":144659,"finalBlow":0,"weaponTypeID":2183,"shipTypeID":17715},{"characterID":93347298,"characterName":"Jelerakk","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":0.3,"damageDone":312,"finalBlow":0,"weaponTypeID":12013,"shipTypeID":12013},{"characterID":93265880,"characterName":"Kraesk","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":-0.6,"damageDone":0,"finalBlow":0,"weaponTypeID":2488,"shipTypeID":626}],"items":[],"position":{"y":21224693760,"x":1346497290240,"z":-998232514560},"zkb":{"locationID":40437462,"hash":"8608b182a6483795c8bc2bc55b2523ffa43df41d","totalValue":72257662.06,"points":1}}"""
    val km = originalkm.replace("KILLTIME", WormholeResidency.datetimeformat.print(DateTime.now()))
    val OM = new ObjectMapper()
    OM.registerModule(DefaultScalaModule)
    val killmail = OM.readValue[Killmail](km, classOf[Killmail])
    val results = WormholeResidency.calculateResidencyModifiers(killmail, 100)
    results(0) must equal(ResidencyModifier(98142695, -100.0, 1.0))
    results(1) must equal(ResidencyModifier(98400028, 100.0, 1.0))
  }

  "the residency modifier calculator" should "calculate residency on an example very busy pos killmail" in {
    val originalkm = """{"killID":49132605,"solarSystemID":31002487,"killTime":"KILLTIME","moonID":40476326,"victim":{"shipTypeID":27532,"characterID":0,"characterName":"","corporationID":98224068,"corporationName":"Dropbears Anonymous","allianceID":99003214,"allianceName":"Brave Collective","factionID":0,"factionName":"","damageTaken":29696311},"attackers":[{"characterID":1968570327,"characterName":"kusto9","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":4.9,"damageDone":10000496,"finalBlow":0,"weaponTypeID":3573,"shipTypeID":19722},{"characterID":1901804450,"characterName":"Teh Replika","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-1.3,"damageDone":449778,"finalBlow":0,"weaponTypeID":3082,"shipTypeID":29984},{"characterID":90311216,"characterName":"Jaiimez Skor","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-1,"damageDone":430333,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":866140127,"characterName":"Alex Zander505","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":4.8,"damageDone":401092,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1610693067,"characterName":"Kev Lar","corporationID":595388333,"corporationName":"Perpetua Umbra","allianceID":2031941852,"allianceName":"Interstellar Alcohol Conglomerate","factionID":0,"factionName":"","securityStatus":2.1,"damageDone":397988,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":90714955,"characterName":"Rezzler","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-2,"damageDone":394405,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1143762065,"characterName":"Ystfrk","corporationID":98377551,"corporationName":"Out of Focus","allianceID":99004013,"allianceName":"Odin's Call","factionID":0,"factionName":"","securityStatus":-1.7,"damageDone":394144,"finalBlow":0,"weaponTypeID":29986,"shipTypeID":29986},{"characterID":1039287135,"characterName":"J3rz11","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":0.5,"damageDone":392357,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":151055436,"characterName":"Jackisntdead","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":1.2,"damageDone":390838,"finalBlow":0,"weaponTypeID":3082,"shipTypeID":29984},{"characterID":90634911,"characterName":"Sari Jasra","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":2.8,"damageDone":388580,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1503395585,"characterName":"Edward Harris","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":3.2,"damageDone":380692,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1599070531,"characterName":"LaserzPewPew","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-1.9,"damageDone":380158,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":93189124,"characterName":"Anomilk Dairlylover","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-2.2,"damageDone":366589,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":892216702,"characterName":"LtauSTinpoWErs","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":1.7,"damageDone":361906,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":835338250,"characterName":"Blizzaro","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":2.2,"damageDone":358346,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":92060039,"characterName":"Braxus Deninard","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-0.7,"damageDone":356481,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":91394400,"characterName":"Avam Sodom","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":4.7,"damageDone":355235,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":686125406,"characterName":"NoobMan","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-1,"damageDone":354830,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":377079915,"characterName":"GDNebu","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":0.6,"damageDone":352872,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":647412341,"characterName":"Lysus","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-0.5,"damageDone":352144,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1817541889,"characterName":"gr33nCO","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":0.2,"damageDone":345360,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":92017289,"characterName":"Abetorix Lincoln","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":4.7,"damageDone":339696,"finalBlow":0,"weaponTypeID":3082,"shipTypeID":29984},{"characterID":988137685,"characterName":"WASPY69","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-4.7,"damageDone":339010,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":2017028242,"characterName":"Bronya Boga","corporationID":98297019,"corporationName":"Isogen 5","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-0.6,"damageDone":333034,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":91867746,"characterName":"Paolo BraBra","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":0.6,"damageDone":327745,"finalBlow":0,"weaponTypeID":3082,"shipTypeID":29984},{"characterID":1734877398,"characterName":"Pantuf","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":4.2,"damageDone":312930,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1029934554,"characterName":"Shpongleye","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":0.6,"damageDone":281041,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":91904026,"characterName":"Luft Reich","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-0.5,"damageDone":280684,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":92372908,"characterName":"Killuminati Savage","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-0.8,"damageDone":270325,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":231456927,"characterName":"Daniel Zorg","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":4.3,"damageDone":266977,"finalBlow":0,"weaponTypeID":3082,"shipTypeID":29984},{"characterID":1174506300,"characterName":"Tatochka","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":5,"damageDone":266581,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":626054918,"characterName":"Axel Stenmark","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":0.4,"damageDone":264947,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":91395281,"characterName":"Krops Vont","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-2,"damageDone":262422,"finalBlow":0,"weaponTypeID":3082,"shipTypeID":29984},{"characterID":91083102,"characterName":"Aurora Roddez","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":0.1,"damageDone":260470,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":91448052,"characterName":"Kopcap 123","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":-0.9,"damageDone":258225,"finalBlow":0,"weaponTypeID":29988,"shipTypeID":29988},{"characterID":91702665,"characterName":"Zaa Bu","corporationID":98139309,"corporationName":"Don't Wake a sleeping bear","allianceID":99004770,"allianceName":"W-Space Citizen","factionID":0,"factionName":"","securityStatus":4.9,"damageDone":255774,"finalBlow":0,"weaponTypeID":2969,"shipTypeID":29990},{"characterID":90554615,"characterName":"Lucuso Andedare","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-0.9,"damageDone":248957,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":484609692,"characterName":"Khendon Kalmire","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-0.8,"damageDone":242799,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":91537000,"characterName":"KOG Eto","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":0.2,"damageDone":240650,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":92966057,"characterName":"Vanko Sokolov","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":1,"damageDone":239730,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1743540392,"characterName":"Jak'at","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":0.3,"damageDone":225297,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":92824013,"characterName":"Mike Hazard","corporationID":98297019,"corporationName":"Isogen 5","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":0.4,"damageDone":224968,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":775422947,"characterName":"Shadow Wyrm","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":1.3,"damageDone":221036,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1603753635,"characterName":"Kithren","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-0.6,"damageDone":220757,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":91203385,"characterName":"Andi Onthatop","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-0.4,"damageDone":220265,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":94481016,"characterName":"Marcus Pernhall","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-2,"damageDone":214398,"finalBlow":0,"weaponTypeID":29988,"shipTypeID":29988},{"characterID":93383361,"characterName":"Caitlin Kittredge","corporationID":98377551,"corporationName":"Out of Focus","allianceID":99004013,"allianceName":"Odin's Call","factionID":0,"factionName":"","securityStatus":-0.9,"damageDone":209660,"finalBlow":0,"weaponTypeID":29988,"shipTypeID":29988},{"characterID":1355387101,"characterName":"Zajar'Gul","corporationID":98297019,"corporationName":"Isogen 5","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":1,"damageDone":204894,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":92660931,"characterName":"Vasiliy Blaz","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":-1.5,"damageDone":201261,"finalBlow":0,"weaponTypeID":3082,"shipTypeID":29988},{"characterID":462896596,"characterName":"RandomRufio","corporationID":98377551,"corporationName":"Out of Focus","allianceID":99004013,"allianceName":"Odin's Call","factionID":0,"factionName":"","securityStatus":-0.3,"damageDone":197784,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1755086631,"characterName":"Murder01","corporationID":98377551,"corporationName":"Out of Focus","allianceID":99004013,"allianceName":"Odin's Call","factionID":0,"factionName":"","securityStatus":0.3,"damageDone":196285,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":91279878,"characterName":"Josh Tsutola","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":0.4,"damageDone":195568,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":356244260,"characterName":"Dan Hour","corporationID":98297019,"corporationName":"Isogen 5","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-3.8,"damageDone":193347,"finalBlow":0,"weaponTypeID":3082,"shipTypeID":29984},{"characterID":94754286,"characterName":"Makoto Akanon","corporationID":98377551,"corporationName":"Out of Focus","allianceID":99004013,"allianceName":"Odin's Call","factionID":0,"factionName":"","securityStatus":-3.1,"damageDone":187024,"finalBlow":1,"weaponTypeID":3082,"shipTypeID":29988},{"characterID":92941592,"characterName":"Foedus Latro","corporationID":98297019,"corporationName":"Isogen 5","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-1.8,"damageDone":181927,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":92383421,"characterName":"liss liss","corporationID":98139309,"corporationName":"Don't Wake a sleeping bear","allianceID":99004770,"allianceName":"W-Space Citizen","factionID":0,"factionName":"","securityStatus":-0.2,"damageDone":181109,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":91900395,"characterName":"Doku Dakar","corporationID":98377551,"corporationName":"Out of Focus","allianceID":99004013,"allianceName":"Odin's Call","factionID":0,"factionName":"","securityStatus":-1.9,"damageDone":180913,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":92910822,"characterName":"Vohann Bezrodnyi","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":-1.3,"damageDone":180838,"finalBlow":0,"weaponTypeID":29988,"shipTypeID":29988},{"characterID":1780444485,"characterName":"Winthorp","corporationID":98297019,"corporationName":"Isogen 5","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":2.9,"damageDone":180299,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1479652894,"characterName":"Skam Master","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":3.8,"damageDone":176062,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":793492139,"characterName":"Lirah","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":5,"damageDone":174692,"finalBlow":0,"weaponTypeID":2969,"shipTypeID":29990},{"characterID":287894697,"characterName":"Sir Lomax","corporationID":98297019,"corporationName":"Isogen 5","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":1.9,"damageDone":169503,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1563651230,"characterName":"StarRunners","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":4.4,"damageDone":166440,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":1241832646,"characterName":"Zag Zor","corporationID":98124409,"corporationName":"Gold Star in Blood Corporation","allianceID":99004770,"allianceName":"W-Space Citizen","factionID":0,"factionName":"","securityStatus":-1.3,"damageDone":166367,"finalBlow":0,"weaponTypeID":29986,"shipTypeID":29986},{"characterID":91877933,"characterName":"Obus Z","corporationID":98377551,"corporationName":"Out of Focus","allianceID":99004013,"allianceName":"Odin's Call","factionID":0,"factionName":"","securityStatus":-1.5,"damageDone":160535,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":93787435,"characterName":"King Creator","corporationID":98377551,"corporationName":"Out of Focus","allianceID":99004013,"allianceName":"Odin's Call","factionID":0,"factionName":"","securityStatus":-1.9,"damageDone":157742,"finalBlow":0,"weaponTypeID":29988,"shipTypeID":29988},{"characterID":434362335,"characterName":"Henry Hao","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":4.7,"damageDone":154831,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":190904562,"characterName":"Pavelex","corporationID":98297019,"corporationName":"Isogen 5","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":1.7,"damageDone":151254,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":1778626276,"characterName":"FypMaH","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":0.2,"damageDone":150613,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":90549844,"characterName":"Keranzit Rusold","corporationID":98139309,"corporationName":"Don't Wake a sleeping bear","allianceID":99004770,"allianceName":"W-Space Citizen","factionID":0,"factionName":"","securityStatus":5,"damageDone":147917,"finalBlow":0,"weaponTypeID":29988,"shipTypeID":29988},{"characterID":92960165,"characterName":"Laras Sulkas","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-1,"damageDone":138288,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":93369941,"characterName":"Freeman_124","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":3.6,"damageDone":137235,"finalBlow":0,"weaponTypeID":24493,"shipTypeID":29986},{"characterID":805654596,"characterName":"Curzon Dax","corporationID":2026831070,"corporationName":"Revenge of the Liquidators","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":-1.8,"damageDone":129219,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":94256448,"characterName":"Wiskee Wiskee","corporationID":98139309,"corporationName":"Don't Wake a sleeping bear","allianceID":99004770,"allianceName":"W-Space Citizen","factionID":0,"factionName":"","securityStatus":-0.6,"damageDone":112886,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":93689290,"characterName":"Martin Bart","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":0.8,"damageDone":112633,"finalBlow":0,"weaponTypeID":29988,"shipTypeID":29988},{"characterID":1411774689,"characterName":"akrobat 12","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":2.1,"damageDone":102250,"finalBlow":0,"weaponTypeID":2969,"shipTypeID":29990},{"characterID":92696223,"characterName":"Polemas","corporationID":98139309,"corporationName":"Don't Wake a sleeping bear","allianceID":99004770,"allianceName":"W-Space Citizen","factionID":0,"factionName":"","securityStatus":4.6,"damageDone":98657,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":93029089,"characterName":"Will Mercar","corporationID":98377551,"corporationName":"Out of Focus","allianceID":99004013,"allianceName":"Odin's Call","factionID":0,"factionName":"","securityStatus":0,"damageDone":91549,"finalBlow":0,"weaponTypeID":29984,"shipTypeID":29984},{"characterID":93055163,"characterName":"Garik 247","corporationID":98091693,"corporationName":"Quantum Explosion","allianceID":99004252,"allianceName":"E X P L O S I O N","factionID":0,"factionName":"","securityStatus":0.5,"damageDone":82855,"finalBlow":0,"weaponTypeID":29988,"shipTypeID":29988},{"characterID":1750549735,"characterName":"grey72","corporationID":98139309,"corporationName":"Don't Wake a sleeping bear","allianceID":99004770,"allianceName":"W-Space Citizen","factionID":0,"factionName":"","securityStatus":1.7,"damageDone":75615,"finalBlow":0,"weaponTypeID":29990,"shipTypeID":29990},{"characterID":470243546,"characterName":"Hidden Fremen","corporationID":98290394,"corporationName":"Lazerhawks","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":0.2,"damageDone":68097,"finalBlow":0,"weaponTypeID":27361,"shipTypeID":29984},{"characterID":172432458,"characterName":"DaJokr","corporationID":98040755,"corporationName":"Hard Knocks Inc.","allianceID":99005065,"allianceName":"Hard Knocks Citizens","factionID":0,"factionName":"","securityStatus":-0.5,"damageDone":45941,"finalBlow":0,"weaponTypeID":27381,"shipTypeID":29984},{"characterID":95115278,"characterName":"Kandrin Hita","corporationID":98224068,"corporationName":"Dropbears Anonymous","allianceID":99003214,"allianceName":"Brave Collective","factionID":0,"factionName":"","securityStatus":-1.2,"damageDone":8894,"finalBlow":0,"weaponTypeID":23561,"shipTypeID":0},{"characterID":93476600,"characterName":"Tajic Kaundur","corporationID":98224068,"corporationName":"Dropbears Anonymous","allianceID":99003214,"allianceName":"Brave Collective","factionID":0,"factionName":"","securityStatus":0.8,"damageDone":1985,"finalBlow":0,"weaponTypeID":23561,"shipTypeID":0},{"characterID":93583695,"characterName":"Miri Arran","corporationID":98297019,"corporationName":"Isogen 5","allianceID":0,"allianceName":"","factionID":0,"factionName":"","securityStatus":0.2,"damageDone":0,"finalBlow":0,"weaponTypeID":8821,"shipTypeID":22456}],"items":[],"zkb":{"hash":"1c76404ef9b2d40b2a456e397711af12bc88ef7e","totalValue":839336006.68,"points":1}}"""
    val km = originalkm.replace("KILLTIME", WormholeResidency.datetimeformat.print(DateTime.now()))
    val OM = new ObjectMapper()
    OM.registerModule(DefaultScalaModule)
    val killmail = OM.readValue[Killmail](km, classOf[Killmail])
    val results = WormholeResidency.calculateResidencyModifiers(killmail, 100)
    results.head.modifier must equal(-100.0)
    results.tail.map(_.modifier).sum must equal(100.0 +- 0.0001)
  }


  "the relevancy calculator" should "return 1.0 for today" in {
    val originalkm ="""{"killID":50129206,"solarSystemID":31001669,"killTime":"KILLTIME","moonID":40437462,"victim":{"shipTypeID":20060,"characterID":0,"characterName":"","corporationID":98142695,"corporationName":"NEMESIS INCORPORATED","allianceID":99004557,"allianceName":"NEMESIS INC UNITED","factionID":0,"factionName":"","damageTaken":13532616},"attackers":[{"characterID":1399881500,"characterName":"Wodo Prophet","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.1,"damageDone":2586683,"finalBlow":0,"weaponTypeID":4306,"shipTypeID":4306},{"characterID":92973922,"characterName":"Kisiar Akriana","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":5,"damageDone":2519495,"finalBlow":0,"weaponTypeID":4302,"shipTypeID":4302},{"characterID":2031871134,"characterName":"Boschala","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":4.6,"damageDone":2195331,"finalBlow":0,"weaponTypeID":28213,"shipTypeID":12005},{"characterID":90515018,"characterName":"Yan Skshetuski","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":2.8,"damageDone":1859096,"finalBlow":1,"weaponTypeID":28211,"shipTypeID":12005},{"characterID":90120220,"characterName":"Bo Rothrock","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.2,"damageDone":1805986,"finalBlow":0,"weaponTypeID":24490,"shipTypeID":12019},{"characterID":92705980,"characterName":"Rioghal Morgan","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":-1.4,"damageDone":935260,"finalBlow":0,"weaponTypeID":28211,"shipTypeID":17843},{"characterID":1522635122,"characterName":"USSDUCK","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.5,"damageDone":548229,"finalBlow":0,"weaponTypeID":27413,"shipTypeID":11995},{"characterID":95851868,"characterName":"Temari Uzumaki","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.7,"damageDone":319799,"finalBlow":0,"weaponTypeID":8105,"shipTypeID":24698},{"characterID":93106560,"characterName":"Keyra D","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":-1,"damageDone":266400,"finalBlow":0,"weaponTypeID":4310,"shipTypeID":4310},{"characterID":1938464267,"characterName":"USSDUCKY","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":0,"damageDone":180602,"finalBlow":0,"weaponTypeID":24700,"shipTypeID":24700},{"characterID":95423733,"characterName":"Ciara Huskarl","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":0,"damageDone":170764,"finalBlow":0,"weaponTypeID":12013,"shipTypeID":12013},{"characterID":94047230,"characterName":"BaldlyGoForth","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":4.3,"damageDone":144659,"finalBlow":0,"weaponTypeID":2183,"shipTypeID":17715},{"characterID":93347298,"characterName":"Jelerakk","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":0.3,"damageDone":312,"finalBlow":0,"weaponTypeID":12013,"shipTypeID":12013},{"characterID":93265880,"characterName":"Kraesk","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":-0.6,"damageDone":0,"finalBlow":0,"weaponTypeID":2488,"shipTypeID":626}],"items":[],"position":{"y":21224693760,"x":1346497290240,"z":-998232514560},"zkb":{"locationID":40437462,"hash":"8608b182a6483795c8bc2bc55b2523ffa43df41d","totalValue":72257662.06,"points":1}}"""
    val km = originalkm.replace("KILLTIME", WormholeResidency.datetimeformat.print(DateTime.now()))
    val OM = new ObjectMapper()
    OM.registerModule(DefaultScalaModule)
    val killmail = OM.readValue[Killmail](km, classOf[Killmail])
    val relevancy = WormholeResidency.calculateRelevancy(killmail)
    relevancy must equal(1.0)
  }

  "the relevancy calculator" should "return 1 over days since it happened" in {
    val originalkm ="""{"killID":50129206,"solarSystemID":31001669,"killTime":"KILLTIME","moonID":40437462,"victim":{"shipTypeID":20060,"characterID":0,"characterName":"","corporationID":98142695,"corporationName":"NEMESIS INCORPORATED","allianceID":99004557,"allianceName":"NEMESIS INC UNITED","factionID":0,"factionName":"","damageTaken":13532616},"attackers":[{"characterID":1399881500,"characterName":"Wodo Prophet","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.1,"damageDone":2586683,"finalBlow":0,"weaponTypeID":4306,"shipTypeID":4306},{"characterID":92973922,"characterName":"Kisiar Akriana","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":5,"damageDone":2519495,"finalBlow":0,"weaponTypeID":4302,"shipTypeID":4302},{"characterID":2031871134,"characterName":"Boschala","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":4.6,"damageDone":2195331,"finalBlow":0,"weaponTypeID":28213,"shipTypeID":12005},{"characterID":90515018,"characterName":"Yan Skshetuski","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":2.8,"damageDone":1859096,"finalBlow":1,"weaponTypeID":28211,"shipTypeID":12005},{"characterID":90120220,"characterName":"Bo Rothrock","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.2,"damageDone":1805986,"finalBlow":0,"weaponTypeID":24490,"shipTypeID":12019},{"characterID":92705980,"characterName":"Rioghal Morgan","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":-1.4,"damageDone":935260,"finalBlow":0,"weaponTypeID":28211,"shipTypeID":17843},{"characterID":1522635122,"characterName":"USSDUCK","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.5,"damageDone":548229,"finalBlow":0,"weaponTypeID":27413,"shipTypeID":11995},{"characterID":95851868,"characterName":"Temari Uzumaki","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":1.7,"damageDone":319799,"finalBlow":0,"weaponTypeID":8105,"shipTypeID":24698},{"characterID":93106560,"characterName":"Keyra D","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":-1,"damageDone":266400,"finalBlow":0,"weaponTypeID":4310,"shipTypeID":4310},{"characterID":1938464267,"characterName":"USSDUCKY","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":0,"damageDone":180602,"finalBlow":0,"weaponTypeID":24700,"shipTypeID":24700},{"characterID":95423733,"characterName":"Ciara Huskarl","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":0,"damageDone":170764,"finalBlow":0,"weaponTypeID":12013,"shipTypeID":12013},{"characterID":94047230,"characterName":"BaldlyGoForth","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":4.3,"damageDone":144659,"finalBlow":0,"weaponTypeID":2183,"shipTypeID":17715},{"characterID":93347298,"characterName":"Jelerakk","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":0.3,"damageDone":312,"finalBlow":0,"weaponTypeID":12013,"shipTypeID":12013},{"characterID":93265880,"characterName":"Kraesk","corporationID":98400028,"corporationName":"Static-Noise","allianceID":99003294,"allianceName":"Upholders","factionID":0,"factionName":"","securityStatus":-0.6,"damageDone":0,"finalBlow":0,"weaponTypeID":2488,"shipTypeID":626}],"items":[],"position":{"y":21224693760,"x":1346497290240,"z":-998232514560},"zkb":{"locationID":40437462,"hash":"8608b182a6483795c8bc2bc55b2523ffa43df41d","totalValue":72257662.06,"points":1}}"""
    val km = originalkm.replace("KILLTIME", WormholeResidency.datetimeformat.print(DateTime.now().minusDays(7)))
    val OM = new ObjectMapper()
    OM.registerModule(DefaultScalaModule)
    val killmail = OM.readValue[Killmail](km, classOf[Killmail])
    val relevancy = WormholeResidency.calculateRelevancy(killmail)
    relevancy must equal(1.0/7.0)
  }

}
